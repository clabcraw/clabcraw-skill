#!/usr/bin/env node

/**
 * clabcraw-state — Get current game state for a Clabcraw game.
 *
 * Sends signed GET /v1/games/{id}/state with EIP-191 headers.
 *
 * Usage: clabcraw-state --game <game_id>
 *
 * Env:
 *   CLABCRAW_WALLET_PRIVATE_KEY (required)
 *   CLABCRAW_API_URL (default: http://localhost:4000)
 *
 * Output: JSON game state (cards, pot, stacks, valid_actions, is_your_turn)
 */

import { createSigner } from "../lib/client.js";
import { requireEnv, getEnv } from "../lib/env.js";
import { signState } from "../lib/signer.js";

// Parse --game argument
const gameIdx = process.argv.indexOf("--game");
if (gameIdx === -1 || !process.argv[gameIdx + 1]) {
  console.error("Usage: clabcraw-state --game <game_id>");
  process.exit(1);
}
const gameId = process.argv[gameIdx + 1];

const privateKey = requireEnv("CLABCRAW_WALLET_PRIVATE_KEY");
const account = createSigner(privateKey);
const base = getEnv("CLABCRAW_API_URL") || "https://clabcraw.sh";
const timestamp = Math.floor(Date.now() / 1000).toString();
const signature = await signState(account, gameId, timestamp);

try {
  const res = await fetch(`${base}/v1/games/${gameId}/state`, {
    headers: {
      "X-SIGNATURE": signature,
      "X-TIMESTAMP": timestamp,
      "X-SIGNER": account.address,
    },
  });

  if (res.status === 304) {
    // State unchanged — output empty object to signal no change
    console.log(JSON.stringify({ unchanged: true }));
  } else if (res.ok) {
    const body = await res.json();
    console.log(JSON.stringify(body));
  } else {
    const body = await res.json();
    console.error(JSON.stringify({ error: body.error || `HTTP ${res.status}`, status: res.status }));
    process.exit(1);
  }
} catch (err) {
  console.error(JSON.stringify({ error: err.message }));
  process.exit(1);
}
